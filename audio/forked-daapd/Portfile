# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem      1.0
PortGroup       github 1.0
PortGroup       locale_select 1.0
PortGroup       LTO 1.0
PortGroup       conflicts_build 1.0

name            forked-daapd
subport         "${name}-devel" {}

if {${subport} eq "${name}"} {
    github.setup    ejurgensen forked-daapd 27.1
    checksums       rmd160  5d331256f1534d616376488b9875ca152b44a068 \
                    sha256  7cce8089ddb4ce4664bcafb33ef6f47df8db7223f552de788d7da30b97375fb0
#                     size    4211141
} else {
    fetch.type      git
    github.setup    ejurgensen forked-daapd 108744e02bce55200c0f9323ac168162008f0990
    # 27.1-251-g108744e
    version         27.1.251
    distname        ${name}-git
    fetch.type      git
}

categories      audio
platforms       macosx linux
license         GPL-2
maintainers     gmail.com:rjvbertin openmaintainer
description     a Linux/FreeBSD DAAP (iTunes), MPD (Music Player Daemon) and RSP (Roku) media server
long_description \
                forked-daapd is a Linux/FreeBSD DAAP (iTunes), MPD (Music Player Daemon) and \
                RSP (Roku) media server. \
                It supports AirPlay devices/speakers, Apple Remote (and compatibles), \
                MPD clients, Chromecast, network streaming, internet radio, Spotify and LastFM. \
                It does not support streaming video by AirPlay nor Chromecast. \
                DAAP stands for Digital Audio Access Protocol which is the protocol used \
                by iTunes and friends to share/stream media libraries over the network. \
                forked-daapd is a complete rewrite of mt-daapd (Firefly Media Server).

depends_build-append \
                port:pkgconfig

depends_lib-append \
                path:lib/pkgconfig/libssl.pc:openssl \
                port:gnutls \
                port:protobuf-c \
                port:curl \
                port:libplist \
                port:ffmpeg \
                port:pulseaudio \
                port:libsodium \
                port:libwebsockets \
                port:zlib \
                port:libconfuse \
                port:libevent \
                port:sqlite3 \
                port:libunistring \
                port:libantlr3c

# TODO : create port:minixml (http://www.minixml.org/)

post-extract {
    # force an auto-reconfig on first build attempt
    file delete -force ${worksrcpath}/configure
}

patch.pre_args  -Np1
if {${subport} eq "${name}"} {
    set parsedfiles ${filespath}/parsed_antlr
    patchfiles-append \
                patch-4-linux-clang.diff
} else {
    set parsedfiles ${filespath}/devel/parsed_antlr
    patchfiles-append \
                devel/patch-4-linux-clang.diff
}

use_autoreconf  yes
autoreconf.args -fvi

pre-configure {
    if {[file exists ${worksrcpath}/configure]} {
        # no need to waste time again
        use_autoreconf no
    }
}

if {${os.platform} eq "darwin" && ${os.major} >= 9} {
    set daapd_user  _daapd
    set daapd_group _daapd
} else {
    set daapd_user  daapd
    set daapd_group daapd
}
add_users ${daapd_user} group=${daapd_group} realname=Daapd\ Service

# don't require antlr3 during builds, use C code generated by the port maintainer
configure.env-append \
                "ANTLR=/bin/echo"

configure.args-append \
                --disable-dependency-tracking \
                --disable-silent-rules

destroot.keepdirs-append \
                ${destroot}${prefix}/var/cache/forked-daapd/

pre-build {
    # install the C code generated by the port maintainer using antlr3
    foreach f [glob -nocomplain ${parsedfiles}/*] {
        set dest ${worksrcpath}/src/[file tail ${f}]
        if {![file exists ${dest}]} {
            file copy ${f} ${dest}
        }
    }
}

post-destroot {
    file rename ${destroot}${prefix}/etc/forked-daapd.conf ${destroot}${prefix}/etc/forked-daapd.conf.sample
    reinplace "s|${prefix}/var/log/|/var/log/|g" ${destroot}${prefix}/etc/forked-daapd.conf.sample
    platform linux {
        xinstall -m 755 -d ${destroot}${prefix}/etc/init.d
        xinstall -m 755 -d ${destroot}${prefix}/etc/logrotate.d
        xinstall -m 755 ${filespath}/init.d ${destroot}${prefix}/etc/init.d/forked-daapd
        xinstall -m 755 ${filespath}/logrotate ${destroot}${prefix}/etc/logrotate.d/forked-daapd
        reinplace "s|@PREFIX@|${prefix}|g" ${destroot}${prefix}/etc/init.d/forked-daapd
    }
}

post-activate {
    if {![file exists ${prefix}/etc/forked-daapd.conf]} {
        xinstall -m 644 ${prefix}/etc/forked-daapd.conf.sample ${prefix}/etc/forked-daapd.conf
    }
    system "chown -R ${daapd_user}:${daapd_group} ${prefix}/var/cache/forked-daapd"
}

notes-append "Please see \
`https://github.com/ejurgensen/forked-daapd/blob/master/README_PULSE.md#user-mode-with-network-access` \
for using your local pulseaudio daemon"
