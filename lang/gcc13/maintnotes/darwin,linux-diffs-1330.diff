--- /opt/local/site-ports/lang/gcc13/Portfile	2025-08-12 23:57:32.568469262 +0200
+++ /opt/local/linux-ports/lang/gcc13/Portfile	2025-08-13 00:10:47.337442434 +0200
@@ -3,14 +3,14 @@
 PortSystem                                       1.0
 PortGroup           select                       1.0
 PortGroup           active_variants              1.1
-PortGroup           conflicts_build              1.0
+PortGroup           conflicts_build              1.1
 
 epoch               0
 name                gcc13
 
 homepage            https://gcc.gnu.org/
 
-platforms           {darwin >= 10}
+platforms           {darwin >= 10} linux
 categories          lang
 maintainers         nomaintainer
 # an exception in the license allows dependents to not be GPL
@@ -21,10 +21,10 @@
                     C, C++, Objective-C, Objective-C++ and Fortran.
 
 # Remember to reset all revision increments below to 0 on new versions
-version             13.3.0
+version             13.3.0 ; revision 2
 
 set libgccname      lib${name}
-subport             ${libgccname} { revision [ expr ${revision} + 0 ] }
+subport             ${libgccname} { revision [ expr ${revision} + 1 ] }
 
 set libcxxname      ${name}-libcxx
 
@@ -50,10 +50,19 @@
 
 depends_build-append \
                     bin:makeinfo:texinfo
-depends_lib-append  port:cctools \
-                    port:gmp \
+platform linux {
+    depends_build-append \
+                    port:binutils \
+                    port:patchelf
+}
+
+platform darwin {
+    depends_lib-append \
+                    port:cctools \
+                    port:ld64
+}
+depends_lib-append  port:gmp \
                     path:lib/pkgconfig/isl.pc:isl \
-                    port:ld64 \
                     port:libiconv \
                     port:libmpc \
                     port:mpfr \
@@ -71,6 +80,20 @@
     configure.pre_args-append --build=${build_arch}-apple-darwin${os.major}
 }
 
+platform linux {
+    set stdcxxabi.is_gcc_internal 1
+    if {[catch {PortGroup libstdcxxabi 1.0} err]} {
+        ui_error "You need to install the MacStrop ports tree too"
+        return -code error "Missing MacStrop port repo"
+    }
+    if {!${stdcxxabi::_GLIBCXX_USE_CXX11_ABI}} {
+        default_variants +oldabi
+        if {![variant_isset oldabi]} {
+            ui_warn "variant `oldabi` unset; code generated by g++-mp-${major} can fail to link with binaries generated from the system C++ runtime!"
+        }
+    }
+}
+
 set gcc_configure_langs {c c++ objc obj-c++ lto fortran}
 if {${subport} eq ${name} && ${build_arch} ne "i386"} {
     # jit compiler is not building on i386 systems
@@ -78,9 +101,13 @@
     lappend gcc_configure_langs jit
 }
 
-if { ${subport} ne ${libcxxname} } {
-    variant m2 conflicts quick description {build the GNU Modula-2 compiler} {}
-}
+#if { ${subport} ne ${libcxxname} } {
+#    if {${subport} eq "${name}"} {
+#        variant m2 conflicts quick description {build the GNU Modula-2 compiler} {}
+#    } else {
+#        variant m2 description {support the GNU Modula-2 compiler} {}
+#    }
+#}
 if {[variant_exists m2] && [variant_isset m2]} {
     lappend gcc_configure_langs m2
 }
@@ -132,14 +159,16 @@
 # see https://lists.macports.org/pipermail/macports-dev/2017-August/036209.html
 # --disable-tls does not limit functionality
 # it only determines how std::call_once works
-configure.args-append  --disable-tls
+platform darwin {
+    configure.args-append  --disable-tls
+}
 
 # Disable ccache
 # configure.ccache    no
 
-if {![info exists xcodecltversion]} {
-    set xcodecltversion ${xcodeversion}
-}
+#if {![info exists xcodecltversion]} {
+#    set xcodecltversion ${xcodeversion}
+#}
 
 if { ${subport} ne ${libcxxname} && ${os.platform} eq "darwin" } {
     # gcc has build issues on macOS 11.3 with the use of Xcode 12.5 clang via cctools for ld
@@ -169,19 +198,31 @@
                     NM_FOR_TARGET=${prefix}/bin/nm \
                     OBJDUMP_FOR_TARGET=${prefix}/bin/objdump \
                     RANLIB_FOR_TARGET=${prefix}/bin/ranlib \
-                    STRIP_FOR_TARGET=${prefix}/bin/strip \
+                    STRIP_FOR_TARGET=${prefix}/bin/strip
+platform darwin {
+    configure.env-append \
                     OTOOL=${prefix}/bin/otool \
                     OTOOL64=${prefix}/bin/otool
+}
 
 #if { ${os.platform} eq "darwin" } {
     # Patch generated from https://github.com/iains/gcc-13-branch
     # git diff --no-prefix releases/gcc-13.1.0 gcc-13.1-darwin-r0
     patchfiles-append       patch-darwin-gcc-${version}.diff
     # Do not abort if 'system' headers in /opt/local/include/gcc are missing
-    patchfiles-append      patch-disable-sys-header-missing-abort.diff
+    patchfiles-append       darwin/patch-disable-sys-header-missing-abort.diff
     # GCC fixinc work-around for sys/ucred.h on OSX10.14.4 no longer seems to work ???
-    if { ${os.major} == 18 } {
-        patchfiles-append  patch-OSX10.14-ucred-atomic-define.diff
+    if { ${os.platform} eq "darwin" && ${os.major} == 18 } {
+        patchfiles-append   darwin/patch-OSX10.14-ucred-atomic-define.diff
+    }
+#} else {
+    patchfiles-append   patch-linux-gcc-configure.diff \
+                        patch-linux-add-macports-paths.diff
+    if {${subport} eq "${name}"} {
+        post-patch {
+            # for now we're hard-coding our mp_extra_rpath
+            reinplace "s|@MP_EXTRA_RPATH@|${mp_extra_rpath}|g" ${worksrcpath}/gcc/gcc.cc
+        }
     }
 #}
 
@@ -196,7 +237,9 @@
 # See:
 #  - https://trac.macports.org/ticket/68683
 #  - https://github.com/gcc-mirror/gcc/commit/b410cf1dc056aab195c5408871ffca932df8a78a
-patchfiles-append   patch-gcc10-disable-macports-cctools-as-changes.diff
+platform darwin {
+    patchfiles-append   darwin/patch-gcc10-disable-macports-cctools-as-changes.diff
+}
 
 configure.env-append \
                     DISABLE_MACPORTS_AS_CLANG_SEARCH=1 \
@@ -239,70 +282,73 @@
 
 }
 
-variant libcxx conflicts stdlib_flag description {enable -stdlib=libc++ as a default, using headers from port:libcxx-dev} {}
+# if {${subport} ne ${libgccname}} {
+    variant libcxx conflicts stdlib_flag description {enable -stdlib=libc++ using headers from port:libcxx-dev} {}
+# }
 
 proc libcxx_incpath {} {
     global prefix name
     if {[variant_exists libcxx] && [variant_isset libcxx]} {
-        return ${prefix}/include/libcxx/v1
+        # this is where port:libcxx puts its headers on Linux!
+        return /usr/include/c++/v1
     } else {
-        return ${prefix}/libexec/${name}/libc++/include/c++/v1
+        return -code error "Internal Portfile error"
     }
 }
 
-subport ${libcxxname} {
-    PortGroup compilers     1.0
-
-    compilers.choose        cxx
-    compilers.setup         -gcc -fortran -clangdevel -clang34 -clang35 -clang36 \
-                            -clang37 -clang50 -clang60 -clang70 -clang80 -clang90
-    if { ![clang_variant_isset] } {
-        if { ${os.platform} eq "darwin" && ${os.major} < 11 } {
-            default_variants-append +clang11
-        } else {
-            default_variants-append +clang16
-        }
-    }
-    revision                [ expr ${revision} + 0 ]
-    description             libc++ header implementation to be used by ${name}+stdlib_flag
-    long_description        {*}${description}.
-    homepage                https://llvm.org/
-    license                 NCSA
-    depends_build
-    depends_extract
-    depends_run
-    depends_lib
-    distfiles
-    patchfiles
-    use_configure           no
-    supported_archs         noarch
-    platforms               any
-    
-    if {[variant_exists libcxx] && [variant_isset libcxx]} {
-        PortGroup stub 1.0
-        long_description-append "\nIn +libcxx mode this is just a stub that depends on libcxx-dev"
-        depends_run-append port:libcxx-dev
-    } else {
-        # Find clang/llvm version to use from active variant
-        proc getClangVersion {} {
-            if { [regexp {clang(.*)} [clang_variant_name] -> clang_v] } {
-                return ${clang_v}
-            }
-            return ""
-        }
-        set mp_clang_ver [getClangVersion]
-        build {
-            # Copy headers from clang-N during build
-            file mkdir ${worksrcpath}/headers
-            file copy ${prefix}/libexec/llvm-${mp_clang_ver}/include/c++/v1 ${worksrcpath}/headers/
-        }
-        destroot {
-            set base_dir [file dirname [libcxx_incpath]]
-            file mkdir ${destroot}${base_dir}
-            file copy ${worksrcpath}/headers/v1 ${destroot}${base_dir}
-        }
-    }
-}
+#subport ${libcxxname} {
+#    PortGroup compilers     1.0
+#
+#    compilers.choose        cxx
+#    compilers.setup         -gcc -fortran -clangdevel -clang34 -clang35 -clang36 \
+#                            -clang37 -clang50 -clang60 -clang70 -clang80 -clang90
+#    if { ![clang_variant_isset] } {
+#        if { ${os.platform} eq "darwin" && ${os.major} < 11 } {
+#            default_variants-append +clang11
+#        } else {
+#            default_variants-append +clang16
+#        }
+#    }
+#    revision                [ expr ${revision} + 0 ]
+#    description             libc++ header implementation to be used by ${name}+stdlib_flag
+#    long_description        {*}${description}.
+#    homepage                https://llvm.org/
+#    license                 NCSA
+#    depends_build
+#    depends_extract
+#    depends_run
+#    depends_lib
+#    distfiles
+#    patchfiles
+#    use_configure           no
+#    supported_archs         noarch
+#    platforms               any
+#    
+#    if {[variant_exists libcxx] && [variant_isset libcxx]} {
+#        PortGroup stub 1.0
+#        long_description-append "\nIn +libcxx mode this is just a stub that depends on libcxx-dev"
+#        depends_run-append port:libcxx-dev
+#    } else {
+#        # Find clang/llvm version to use from active variant
+#        proc getClangVersion {} {
+#            if { [regexp {clang(.*)} [clang_variant_name] -> clang_v] } {
+#                return ${clang_v}
+#            }
+#            return ""
+#        }
+#        set mp_clang_ver [getClangVersion]
+#        build {
+#            # Copy headers from clang-N during build
+#            file mkdir ${worksrcpath}/headers
+#            file copy ${prefix}/libexec/llvm-${mp_clang_ver}/include/c++/v1 ${worksrcpath}/headers/
+#        }
+#        destroot {
+#            set base_dir [file dirname [libcxx_incpath]]
+#            file mkdir ${destroot}${base_dir}
+#            file copy ${worksrcpath}/headers/v1 ${destroot}${base_dir}
+#        }
+#    }
+#}
 
 if { ${subport} ne ${libcxxname} } {
 ### MacStrop private
@@ -316,14 +362,11 @@
 ### MacStrop private
 
     # the quick variant simplifies gcc patch development but also decreases the build time by a factor > 4.
-    variant quick description "Build ${name} without the usual 3-stage bootstrap. Much faster but not recommended except for debugging" {}
+    variant quick description "Build ${name} without the usual 3-stage bootstrap. Much faster but not recommended" {}
     if {![variant_exists quick] || ![variant_isset quick]} {
         configure.ccache no
     } else {
         ui_debug "Allowing +quick builds with ccache"
-        configure.cflags-append "-g"
-        configure.cxxflags-append "-g"
-        configure.ldflags-append "-g"
     }
 
     variant no_sanit description {don't include the sanitiser libraries} {
@@ -333,40 +376,46 @@
         }
     }
 
-    variant stdlib_flag conflicts libcxx description {Enable stdlib command line flag to select c++ runtime} {
-        # Enables support for specifying the c++ runtime via `-stdlib=` in a similar
-        # way to clang. For more details see the later comments in
-        #   https://www.mail-archive.com/gcc-patches@gcc.gnu.org/msg257385.html
-        # Note : This 'bakes' the libc++ include directory into gcc,
-        # which is then used as the default search location when `-stdlib=libc++`
-        # is given. Therefore to have consistency across various OS versions, and to enable
-        # modern c++ standards, use a recent macports clang port to provide this.
-        if {${subport} eq ${name}} {
-            depends_run-append port:${libcxxname}
-            require_active_variants port:${libcxxname} {} libcxx
-        }
-        configure.args-append --with-gxx-libcxx-include-dir="[libcxx_incpath]"
-    }
+#    variant stdlib_flag conflicts libcxx description {Enable stdlib command line flag to select c++ runtime} {
+#        # Enables support for specifying the c++ runtime via `-stdlib=` in a similar
+#        # way to clang. For more details see the later comments in
+#        #   https://www.mail-archive.com/gcc-patches@gcc.gnu.org/msg257385.html
+#        # Note : This 'bakes' the libc++ include directory into gcc,
+#        # which is then used as the default search location when `-stdlib=libc++`
+#        # is given. Therefore to have consistency across various OS versions, and to enable
+#        # modern c++ standards, use a recent macports clang port to provide this.
+#        if {${subport} eq ${name}} {
+#            depends_run-append port:${libcxxname}
+#            require_active_variants port:${libcxxname} {} libcxx
+#        }
+#        configure.args-append --with-gxx-libcxx-include-dir="[libcxx_incpath]"
+#    }
     if {[variant_exists libcxx] && [variant_isset libcxx]} {
         if {${subport} eq ${name}} {
             depends_build-append \
-                port:libcxx-dev
-            depends_run-append \
-                port:${libcxxname}
-            require_active_variants port:${libcxxname} libcxx
-            require_active_variants libcxx-dev macports_libcxx
-            patchfiles-append \
-                    patch-use-libcxx-by-default.diff
+                path:share/doc/libcxx/provider:libcxx \
+                path:lib/pkgconfig/libcxx.pc:libcxx-dev
+            if {${os.platform} eq "darwin"} {
+                depends_run-append \
+                    port:${libcxxname}
+                require_active_variants port:${libcxxname} libcxx
+                require_active_variants libcxx-dev macports_libcxx
+            } else {
+                depends_run-append \
+                    path:share/doc/libcxx/provider:libcxx \
+                    path:lib/pkgconfig/libcxx.pc:libcxx-dev
+            }
         }
+        patchfiles-append \
+                    patch-use-libcxx-on-linux.diff
         configure.args-append --with-gxx-libcxx-include-dir="[libcxx_incpath]"
     }
 
     # libcxx is unavailable on PPC
     if {${build_arch} ni [list ppc ppc64]} {
-        if {${os.platform} eq "darwin" && ${os.major} >= 13 && ![variant_isset stdlib_flag]} {
+        #default_variants-append +stdlib_flag
+        if {![variant_isset stdlib_flag]} {
             default_variants-append +libcxx
-        } else {
-            default_variants-append +stdlib_flag
         }
     }
 
@@ -404,14 +453,18 @@
 
 destroot.target     install install-info-host
 
-# gcc cannot build if these are active (port:binutils-dev may not exist but that is not a problem here)
-conflicts_build-append libunwind-headers binutils binutils-dev gdb
+if {${os.platform} eq "darwin"} {
+    # gcc cannot build if these are active
+    conflicts_build-append libunwind-headers binutils gdb
+} else {
+    conflicts_build-append libunwind-dev binutils-dev gdb gettext-dev
+}
 
 # Find dylibs at a given location
 proc dylib_list {location} {
-    # Note *.*.dylib is to only match versioned dylibs, not the versionless sym links
-    set dylibs [glob -directory ${location} -tails *.*.dylib]
-    ui_debug "Found at ${location} dylibs : ${dylibs}"
+    # Note we just handle all .so files.
+    set dylibs [glob -directory ${location} -tails *.so*]
+    ui_debug "Found at ${location} solibs : ${dylibs}"
     return ${dylibs}
 }
 
@@ -499,48 +552,58 @@
 
         # Temporary working dir for dylibs
         file mkdir ${destroot}${prefix}/lib/libgcc.merged
+        platform linux {
+            # note: this assumes 64bit builds and breaks multi-arch builds (which we don't support anyway)
+            catch {system "ls -l ${destroot}${prefix}/lib/lib64 "}
+            foreach l [glob -nocomplain -directory ${destroot}${prefix}/lib/lib64 -tails *] {
+                file rename ${destroot}${prefix}/lib/lib64/${l} ${destroot}${prefix}/lib/libgcc/
+            }
+            # gcc links libfoo.so and libfoo.so.X both to libfoo.so.X.Y.Z, rather than
+            # linking libfoo.so to libfoo.so.X and that one to libfoo.so.X.Y.Z .
+            # Probably a detail, but fix that:
+            foreach l [glob -nocomplain -directory ${destroot}${prefix}/lib/libgcc -tails *.so.\[0-9\]] {
+                set dylib_nover \
+                    "[string range ${l} 0 [string last ".so" ${l}]]so"
+                ln -s -f ${l} ${destroot}${prefix}/lib/libgcc/${dylib_nover}
+            }
+            system "ls -l ${destroot}${prefix}/lib/libgcc "
+        }
 
         # loop over libs to install
         set dylibs [dylib_list ${destroot}${prefix}/lib/libgcc]
         foreach dylib ${dylibs} {
 
-            # Different OS versions (e.g. Leopard) or architectures (e.g. PPC) don't produce all the dylibs
-            # https://trac.macports.org/ticket/40098
-            # https://trac.macports.org/ticket/40100
-            if { ![file exists ${destroot}${prefix}/lib/libgcc/${dylib}] } {
-                continue
-            }
-
             # Move dylib to temp area
-            move ${destroot}${prefix}/lib/libgcc/${dylib} ${destroot}${prefix}/lib/libgcc.merged
+            ui_debug "${destroot}${prefix}/lib/libgcc/${dylib} -> ${destroot}${prefix}/lib/libgcc.merged/"
+            file rename ${destroot}${prefix}/lib/libgcc/${dylib} ${destroot}${prefix}/lib/libgcc.merged/
 
-            # If needed create versionless sym link to dylib
-            set dylib_split [split ${dylib} "."]
-            set dylib_nover ${destroot}${prefix}/lib/libgcc.merged/[lindex ${dylib_split} 0].[lindex ${dylib_split} end]
-            if { ![file exists ${dylib_nover}]  } {
-                ln -s ${dylib} ${dylib_nover}
-            }
-
-            # Universal support
-            if {[variant_exists universal] && [variant_isset universal]} {
-                foreach archdir [glob ${destroot}${prefix}/lib/libgcc/*/] {
-                    set archdir_nodestroot [string map "${destroot}/ /" ${archdir}]
-                    if {[file exists ${archdir}/${dylib}]} {
-                        system "install_name_tool -id ${prefix}/lib/libgcc/${dylib} ${archdir}/${dylib}"
-                        foreach link [glob -tails -directory ${archdir} *.dylib] {
-                            system "install_name_tool -change ${archdir_nodestroot}${link} ${prefix}/lib/libgcc/${link} ${archdir}/${dylib}"
-                        }
-                        system "lipo -create -output ${destroot}${prefix}/lib/libgcc.merged/${dylib}~ ${destroot}${prefix}/lib/libgcc.merged/${dylib} ${archdir}/${dylib} && mv ${destroot}${prefix}/lib/libgcc.merged/${dylib}~ ${destroot}${prefix}/lib/libgcc.merged/${dylib}"
-                    }
-                }
-            }
-
-            # strip debug symbols to supress debugger warnings:
-            # http://trac.macports.org/attachment/ticket/34831
-            if {! [string match *libgcc_ext* ${dylib}]} {
-                system "strip -x ${destroot}${prefix}/lib/libgcc.merged/${dylib}"
-            }
-        }
+#             platform darwin {
+#                 # Universal support
+#                 if {[variant_exists universal] && [variant_isset universal]} {
+#                     foreach archdir [glob ${destroot}${prefix}/lib/libgcc/*/] {
+#                         set archdir_nodestroot [string map "${destroot}/ /" ${archdir}]
+#                         if {[file exists ${archdir}/${dylib}]} {
+#                             system "install_name_tool -id ${prefix}/lib/libgcc/${dylib} ${archdir}/${dylib}"
+#                             foreach link [glob -tails -directory ${archdir} *.dylib] {
+#                                 system "install_name_tool -change ${archdir_nodestroot}${link} ${prefix}/lib/libgcc/${link} ${archdir}/${dylib}"
+#                             }
+#                             system "lipo -create -output ${destroot}${prefix}/lib/libgcc.merged/${dylib}~ ${destroot}${prefix}/lib/libgcc.merged/${dylib} ${archdir}/${dylib} && mv ${destroot}${prefix}/lib/libgcc.merged/${dylib}~ ${destroot}${prefix}/lib/libgcc.merged/${dylib}"
+#                         }
+#                     }
+#                 }
+# 
+#                 # strip debug symbols to supress debugger warnings:
+#                 # http://trac.macports.org/attachment/ticket/34831
+#                 if {! [string match *libgcc_ext* ${dylib}]} {
+#                     system "strip -x ${destroot}${prefix}/lib/libgcc.merged/${dylib}"
+#                 }
+#             }
+        }
+        system "ls -l ${destroot}${prefix}/lib/libgcc.merged"
+        # install the LTO linker plugin for use by `nm`:
+        xinstall -m 755 -d ${destroot}${prefix}/lib/bfd-plugins
+        file rename ${destroot}${prefix}/libexec/gcc/x86_64-pc-linux-gnu/13.3.0/liblto_plugin.so \
+                    ${destroot}${prefix}/lib/bfd-plugins/
 
         file delete -force ${destroot}${prefix}/bin
         file delete -force ${destroot}${prefix}/share
@@ -549,21 +612,21 @@
 
         move ${destroot}${prefix}/lib/libgcc.merged ${destroot}${prefix}/lib/libgcc
 
-        if {[variant_isset quick]} {
-            ui_msg "--->  Generating the .dSYM bundles because of +quick: find ${destroot}${prefix} -type f '(' -name '*.dylib' -or -name '*.so' ')' -exec dsymutil {} +"
-            system -W ${destroot}${prefix} "find . -type f '(' -name '*.dylib' -or -name '*.so' ')' -exec dsymutil {} +"
+        # For binary compatibility with binaries that linked against the old libstdcxx port
+        if {${os.platform} eq "darwin"} {
+            ln -s libgcc/libstdc++.6.dylib ${destroot}${prefix}/lib/libstdc++.6.dylib
+        } else {
+            ln -s libgcc/libstdc++.so.6 ${destroot}${prefix}/lib/libstdc++.so.6
         }
 
-        # For binary compatibility with binaries that linked against the old libstdcxx port
-        ln -s libgcc/libstdc++.6.dylib ${destroot}${prefix}/lib/libstdc++.6.dylib
-        # in case someone uses our libc++-enabled version to generate a binary that doesn't store the full path
-        # to the required libc++ but does (of course) have the RPATH info for the libgcc directory:
-        if {[variant_isset libcxx]} {
-            # install symlinks to the libc++ linker interfaces in a place where GCC's runtime libraries are stored:
-            ln -s ${prefix}/lib/libc++.1.dylib ${destroot}${prefix}/lib/libgcc/
-            ln -s ${prefix}/lib/libc++abi.1.dylib ${destroot}${prefix}/lib/libgcc/
+        if {[variant_isset oldabi]} {
+            system -W ${destroot}${prefix}/include/gcc "${patch.cmd} -Np0 -i ${filespath}/patch-force-oldcxxabi.diff"
         }
 
+        ## install the ABI detector script
+        xinstall -m 755 -d ${destroot}${prefix}/libexec/libgcc
+        xinstall -m 755 ${filespath}/get_GLIBCXX_USE_CXX11_ABI.sh ${destroot}${prefix}/libexec/libgcc
+
         ### MacStrop private
         # user might want to preserve runtime libraries currently installed by previous libgccX ports:
         preserve_runtime_libraries_ports gcc7 libgcc8
@@ -578,6 +641,8 @@
     # RJVB : should we add an explicit depends_run on port:${libgccname}?
     require_active_variants libgcc {} {gcc7 gcc8 gcc9 gcc10 gcc11 gcc12}
 
+    stdcxxabi.dependencies_concerned_by_ABI port:libgcc${major}
+
     post-destroot {
 
         file delete ${destroot}${prefix}/share/info/dir
@@ -610,11 +675,29 @@
             }
         }
 
+        # the MacPorts activation process breaks hardlinks on Linux; avoid that
+        set target [exec ${worksrcpath}/config.guess]
+        if {[file exists ${destroot}${prefix}/bin/${target}-c++-mp-${major}]} {
+            ln -sf ${target}-g++-mp-${major} ${destroot}${prefix}/bin/${target}-c++-mp-${major}
+            ln -sf ${target}-g++-mp-${major} ${destroot}${prefix}/bin/g++-mp-${major}
+            ln -sf ${target}-g++-mp-${major} ${destroot}${prefix}/bin/c++-mp-${major}
+            ln -sf ${target}-gcc-${major}.3.0 ${destroot}${prefix}/bin/gcc-mp-${major}
+            foreach b {gcc-ar gcc-nm gcc-ranlib gfortran} {
+                ln -sf ${target}-${b}-mp-${major} ${destroot}${prefix}/bin/${b}-mp-${major}
+            }
+        } else {
+            ui_warn "Mis-guessed the target \"triplet\" as \"${target}\"."
+            ui_msg "The files below (if any) will be copies of each other instead of symlinks:"
+            ui_msg "[file -nocomplain ${destroot}${prefix}/bin/${target}-*-mp-${major}]"
+        }
+
+        if {[variant_isset oldabi]} {
+            system -W ${destroot}${prefix}/include/gcc${major} "${patch.cmd} -Np0 -i ${filespath}/patch-force-oldcxxabi.diff"
+        }
     }
 
     select.group        gcc
     select.file         ${filespath}/mp-${name}
-
 }
 
 if { ${subport} ne ${libcxxname} } {
@@ -626,16 +709,36 @@
     }
 
     post-destroot {
+        platform linux {
+            # note: this assumes 64bit builds and breaks multi-arch builds (which we don't support anyway)
+            catch {system "ls -l ${destroot}${prefix}/lib/lib64 "}
+            foreach l [glob -nocomplain -directory ${destroot}${prefix}/lib/lib64 -tails *] {
+                file rename ${destroot}${prefix}/lib/lib64/${l} ${destroot}${prefix}/lib/gcc${major}/
+            }
+            # gcc links libfoo.so and libfoo.so.X both to libfoo.so.X.Y.Z, rather than
+            # linking libfoo.so to libfoo.so.X and that one to libfoo.so.X.Y.Z .
+            # Probably a detail, but fix that:
+            foreach l [glob -nocomplain -directory ${destroot}${prefix}/lib/gcc${major} -tails *.so.\[0-9\]] {
+                set dylib_nover \
+                    "[string range ${l} 0 [string last ".so" ${l}]]so"
+                ln -s -f ${l} ${destroot}${prefix}/lib/gcc${major}/${dylib_nover}
+            }
+            catch {system "ls -l ${destroot}${prefix}/lib/gcc${major} "}
+        }
+
         # Ensure all dylibs in destroot have our extra rpath added ..
         # https://trac.macports.org/ticket/65503
-        foreach dlib [ exec find ${destroot}${prefix} -type f -and -name "*.dylib" ] {
+        set nrpath "${prefix}/lib:${mp_extra_rpath}:${prefix}/lib/${name}"
+        foreach dlib [ exec find ${destroot}${prefix} -name "*.so" ] {
             ui_debug "Ensuring DYLIB '${dlib}' has RPATH '${mp_extra_rpath}'"
-            # Note install_name_tool returns a failure if the dylib already has the entry
-            # We don't want that here so force final status to be true...
-            system "install_name_tool -add_rpath ${mp_extra_rpath} ${dlib} > /dev/null 2>&1 ; true"
+            catch {system "patchelf --set-rpath ${nrpath} ${dlib}"}
         }
     }
 
+    # make sure our binaries know about the install locations!
+    configure.ldflags-append \
+        -Wl,-rpath,${prefix}/lib/libgcc
+
     platform powerpc {
         configure.universal_archs ppc ppc64
     }
@@ -651,8 +754,13 @@
             configure.universal_archs i386 x86_64
         }
     }
-    variant universal {
-        configure.args-delete --disable-multilib
+    if {${os.platform} eq "darwin"} {
+        variant universal {
+            configure.args-delete --disable-multilib
+        }
+    } else {
+        # don't inject -I${prefix}/include
+        compiler.cpath
     }
     # the generated compiler doesn't accept -arch
     configure.env-append \
@@ -663,7 +771,7 @@
         "CPP=${configure.cc} -E" \
         "CPP_FOR_BUILD=${configure.cc} -E" \
         "CXXCPP=${configure.cxx} -E"
-    if {[variant_exists libcxx] && [variant_isset libcxx] && ![variant_isset quick]} {
+    if {${subport} eq "${name}" && [variant_exists libcxx] && [variant_isset libcxx] && ![variant_isset quick]} {
         post-patch {
             reinplace "s|BOOT_CFLAGS= -g -O2|BOOT_CFLAGS= -Os|g" ${worksrcpath}/Makefile.in
         }
@@ -678,9 +786,9 @@
             "VOID_STAGE_COMPARISON=1" \
             "BOOT_CFLAGS=-Os" \
             "CFLAGS_FOR_TARGET=${configure.cflags} ${LTO.cpuflags}" \
-            "CXXFLAGS_FOR_TARGET=${configure.cxxflags} ${LTO.cpuflags} -stdlib=libstdc++" \
-            "LDFLAGS_FOR_TARGET=-stdlib=libstdc++"
-        # RJVB: tweak the bootstrap stage C(XX)FLAGS, in particular that the stage2 and stage3 compiler
+            "CXXFLAGS_FOR_TARGET=${configure.cxxflags} ${LTO.cpuflags}"
+        # RJVB:
+        # On Mac we tweak the bootstrap stage C(XX)FLAGS, in particular that the stage2 and stage3 compiler
         # don't try to use/build against libc++; idem for building the target libraries with the final
         # compiler (*FLAGS_FOR_TARGET).
         # NB: this assumes that the bootstrap compiler uses an appropriate default; just set it to -Os
@@ -690,24 +798,15 @@
             "STAGE1_CFLAGS=-Os" \
             "STAGE1_CXXFLAGS=-Os" \
             "STAGE2_CFLAGS=-Os" \
-            {*}"STAGE2_CXXFLAGS=\"-Os -stdlib=libstdc++\"" \
-            "STAGE2_LDFLAGS=\"-stdlib=libstdc++\"" \
+            "STAGE2_CXXFLAGS=-Os" \
             "STAGE3_CFLAGS=\"${configure.cflags} ${LTO.cpuflags}\"" \
-            "STAGE3_CXXFLAGS=\"${configure.cxxflags} ${LTO.cpuflags} -stdlib=libstdc++\"" \
-            "STAGE3_LDFLAGS=\"-stdlib=libstdc++\"" \
+            "STAGE3_CXXFLAGS=\"${configure.cxxflags} ${LTO.cpuflags}\"" \
             "CFLAGS_FOR_TARGET=\"-g ${configure.cflags} ${LTO.cpuflags}\"" \
-            "CXXFLAGS_FOR_TARGET=\"-g ${configure.cxxflags} ${LTO.cpuflags} -stdlib=libstdc++\"" \
-            "LDFLAGS_FOR_TARGET=\"-g -stdlib=libstdc++\"" \
-            "do-compare=/usr/bin/true" \
+            "CXXFLAGS_FOR_TARGET=\"-g ${configure.cxxflags} ${LTO.cpuflags}\"" \
+            "do-compare=/bin/true" \
             {*}${preargs}
         depends_build-append port:gmake
         build.cmd ${prefix}/bin/gmake
-
-        post-destroot {
-            # install symlinks to the libc++ linker interfaces in a place where GCC looks for its own link libraries:
-            ln -s ${prefix}/lib/libc++.dylib ${destroot}${prefix}/lib/${name}/
-            ln -s ${prefix}/lib/libc++abi.dylib ${destroot}${prefix}/lib/${name}/
-        }
     }
     configure.cc-append [get_canonical_archflags]
     if {[variant_exists quick] && [variant_isset quick]} {
